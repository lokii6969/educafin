<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EducaFin 2.0 - Gestão Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Confetti Library for Goals -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Mobile Navigation */
        .nav-item.active { color: #059669; font-weight: 600; }
        .nav-item.active::after { content: ''; display: block; width: 100%; height: 3px; background: #059669; border-radius: 2px; margin-top: 4px; }
        .fab { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
        .stat-card:hover { transform: translateY(-2px); transition: transform 0.2s ease; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .accordion-content { transition: max-height 0.3s ease-out; max-height: 0; overflow: hidden; }
        .accordion-content.open { max-height: 200px; }
        
        /* Custom Scrollbar for sleek look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- TELA DE LOGIN & CONTEÚDO PÚBLICO (Mantido) -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-gradient-to-br from-emerald-800 to-teal-900 overflow-y-auto">
        <div class="min-h-screen flex flex-col md:flex-row">
            <!-- Lado Esquerdo -->
            <div class="w-full md:w-1/2 flex flex-col justify-center items-center p-8 text-white relative">
                <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="max-w-md w-full relative z-10">
                    <div class="mb-8 text-center md:text-left">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-lg bg-emerald-500 mb-4 shadow-lg shadow-emerald-900/50">
                            <i class="fas fa-wallet text-2xl"></i>
                        </div>
                        <h1 class="text-4xl font-bold mb-2 tracking-tight">EducaFin</h1>
                        <p class="text-emerald-100 text-lg">Sua liberdade financeira começa aqui.</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md p-8 rounded-2xl border border-white/20 shadow-2xl">
                        <button id="google-login-button" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 rounded-xl hover:bg-gray-50 transition flex items-center justify-center gap-3 mb-4 shadow-sm group">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-5 h-5 group-hover:scale-110 transition"/>
                            Entrar com Google
                        </button>
                        <button id="anonymous-login-button" class="w-full bg-emerald-600/80 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2 shadow-sm border border-emerald-500/50">
                            <i class="fas fa-user-secret"></i> Entrar sem cadastro
                        </button>
                        <p id="auth-status" class="text-xs text-red-300 mt-4 text-center min-h-[20px]"></p>
                    </div>
                </div>
            </div>
            <!-- Lado Direito -->
            <div class="w-full md:w-1/2 bg-slate-50 text-slate-800 rounded-t-3xl md:rounded-l-3xl md:rounded-tr-none overflow-hidden relative shadow-2xl">
                <div id="public-view-container" class="h-full overflow-y-auto p-8 md:p-12 lg:p-16">
                    <!-- VIEW 1: HOME PÚBLICA -->
                    <div id="public-home" class="fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <span class="px-3 py-1 bg-emerald-100 text-emerald-800 rounded-full text-xs font-bold uppercase tracking-wide">Conteúdo Aberto</span>
                            <button onclick="showPublicAgenda()" class="text-sm font-bold text-emerald-600 hover:text-emerald-700 flex items-center gap-1">
                                <i class="far fa-calendar-alt"></i> Ver Agenda Completa
                            </button>
                        </div>
                        <h2 class="text-3xl font-bold mb-8 text-slate-800">Dicas Financeiras para Todos</h2>
                        <div id="public-posts-list" class="space-y-8"></div>
                        <div class="p-6 bg-white rounded-xl border border-slate-200 mt-10 shadow-sm hover:shadow-md transition cursor-pointer group" onclick="showPublicAgenda()">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h4 class="font-bold text-slate-700 mb-1 group-hover:text-emerald-600 transition"><i class="fas fa-calendar-check text-emerald-500 mr-2"></i>Próximos Eventos</h4>
                                    <p class="text-sm text-slate-600">Confira workshops e palestras gratuitas.</p>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-emerald-100 group-hover:text-emerald-600 transition"><i class="fas fa-arrow-right"></i></div>
                            </div>
                        </div>
                    </div>
                    <!-- VIEW 2: LEITOR BLOG -->
                    <div id="public-blog-reader" class="hidden fade-in">
                        <button onclick="showPublicHome()" class="mb-6 text-sm text-slate-500 hover:text-emerald-600 font-medium flex items-center gap-2 transition"><i class="fas fa-arrow-left"></i> Voltar</button>
                        <article id="blog-content-area">
                            <span id="blog-category" class="text-emerald-600 font-bold text-sm uppercase tracking-wider"></span>
                            <h1 id="blog-title" class="text-3xl md:text-4xl font-bold text-slate-900 mt-2 mb-6 leading-tight"></h1>
                            <div id="blog-body" class="prose prose-emerald text-slate-600 leading-relaxed space-y-4"></div>
                        </article>
                    </div>
                    <!-- VIEW 3: AGENDA -->
                    <div id="public-agenda" class="hidden fade-in">
                        <button onclick="showPublicHome()" class="mb-6 text-sm text-slate-500 hover:text-emerald-600 font-medium flex items-center gap-2 transition"><i class="fas fa-arrow-left"></i> Voltar</button>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Agenda de Eventos</h2>
                        <div id="public-events-list-container" class="space-y-4 mt-6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL (Área Logada) -->
    <div id="app-container" class="hidden flex flex-col h-full">
        <!-- Top Bar -->
        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-emerald-600 rounded-lg flex items-center justify-center text-white font-bold shadow-sm">
                    <i class="fas fa-wallet"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-800 text-lg leading-tight">EducaFin</h1>
                    <p id="header-greeting" class="text-xs text-slate-500">Olá</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="exportReport()" class="hidden md:flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-50 rounded-lg border border-slate-200 transition">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <img id="user-photo" class="w-8 h-8 rounded-full bg-slate-200 object-cover border border-slate-100" src="" alt="Perfil">
                <button id="logout-button" class="ml-2 w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 transition rounded-full hover:bg-red-50">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative">
            <!-- Sidebar Desktop -->
            <aside class="hidden md:flex w-64 flex-col border-r border-slate-200 bg-white">
                <nav class="flex-1 p-4 space-y-1">
                    <button data-tab="dashboard" class="nav-item-desktop active w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg bg-emerald-50 text-emerald-700">
                        <i class="fas fa-home w-5"></i> Visão Geral
                    </button>
                    <button data-tab="transactions" class="nav-item-desktop w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900">
                        <i class="fas fa-list w-5"></i> Transações
                    </button>
                    <button data-tab="goals" class="nav-item-desktop w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900">
                        <i class="fas fa-bullseye w-5"></i> Metas
                    </button>
                    <button data-tab="education" class="nav-item-desktop w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900">
                        <i class="fas fa-question-circle w-5"></i> Ajuda & Aprender
                    </button>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto bg-slate-50 p-4 pb-24 md:p-8">
                
                <!-- VIEW: Dashboard (INCREMENTADO) -->
                <div id="dashboard" class="space-y-6 max-w-5xl mx-auto fade-in">
                    <!-- Greeting & Quick Actions -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 id="dash-greeting-title" class="text-2xl font-bold text-slate-800">Bom dia, Usuário!</h2>
                            <p class="text-slate-500 text-sm">Aqui está o resumo das suas finanças hoje.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openTransactionModal('income')" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-bold hover:bg-emerald-200 transition flex items-center gap-2"><i class="fas fa-plus"></i> Receita</button>
                            <button onclick="openTransactionModal('expense')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-bold hover:bg-red-200 transition flex items-center gap-2"><i class="fas fa-minus"></i> Despesa</button>
                        </div>
                    </div>

                    <!-- Cards de Resumo -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="stat-card bg-gradient-to-br from-emerald-500 to-teal-600 p-5 rounded-2xl text-white shadow-lg shadow-emerald-200 relative overflow-hidden">
                            <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2"><i class="fas fa-wallet text-6xl"></i></div>
                            <p class="text-emerald-100 text-sm font-medium mb-1">Saldo Atual</p>
                            <p id="current-balance" class="text-3xl font-bold">R$ 0,00</p>
                            <div class="mt-4 text-xs bg-white/20 inline-block px-2 py-1 rounded">Disponível</div>
                        </div>
                        <div class="stat-card bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wide mb-1">Entradas do Mês</p>
                                    <p id="total-income" class="text-xl font-bold text-emerald-600">R$ 0,00</p>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center"><i class="fas fa-arrow-down"></i></div>
                            </div>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full mt-3 overflow-hidden">
                                <div class="bg-emerald-500 h-full w-full opacity-50"></div>
                            </div>
                        </div>
                        <div class="stat-card bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wide mb-1">Saídas do Mês</p>
                                    <p id="total-expense" class="text-xl font-bold text-red-500">R$ 0,00</p>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-arrow-up"></i></div>
                            </div>
                            <!-- Budget Bar -->
                            <div class="mt-3">
                                <div class="flex justify-between text-xs text-slate-400 mb-1"><span>Orçamento Comprometido</span><span id="budget-percent">0%</span></div>
                                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                    <div id="budget-bar" class="bg-red-500 h-full w-0 transition-all duration-500"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Chart Section -->
                        <div class="md:col-span-2 bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-slate-700">Fluxo de Caixa</h3>
                                <div class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">Últimos 30 dias</div>
                            </div>
                            <div class="h-64 w-full"><canvas id="expense-chart"></canvas></div>
                        </div>

                        <!-- Mini Recent Activity -->
                        <div class="md:col-span-1 bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col">
                            <h3 class="font-bold text-slate-700 mb-4">Atividade Recente</h3>
                            <div id="recent-activity-list" class="space-y-4 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                                <!-- JS injected -->
                            </div>
                            <button onclick="switchTab('transactions')" class="w-full mt-4 py-2 text-sm text-emerald-600 font-bold bg-emerald-50 rounded-lg hover:bg-emerald-100 transition">Ver Extrato Completo</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Transactions (INCREMENTADO) -->
                <div id="transactions" class="hidden max-w-4xl mx-auto fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Extrato</h2>
                            <p class="text-slate-500 text-sm">Seu histórico de movimentações.</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <div class="relative flex-1 md:flex-none md:w-64">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="trans-search" placeholder="Buscar (ex: Uber, Mercado)..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-emerald-500 text-sm" onkeyup="renderTransactionsList()">
                            </div>
                            <select id="trans-month-filter" class="px-3 py-2 rounded-lg border border-slate-200 bg-white text-sm focus:outline-none focus:border-emerald-500" onchange="renderTransactionsList()">
                                <option value="all">Todos os meses</option>
                                <!-- JS populated -->
                            </select>
                        </div>
                    </div>

                    <!-- Filter Tabs -->
                    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button data-filter="all" class="filter-btn active px-4 py-1.5 text-sm font-bold rounded-full bg-slate-800 text-white shadow-md transition transform hover:scale-105">Todos</button>
                        <button data-filter="income" class="filter-btn px-4 py-1.5 text-sm font-bold rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-emerald-50 hover:text-emerald-700 transition">Entradas</button>
                        <button data-filter="expense" class="filter-btn px-4 py-1.5 text-sm font-bold rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-red-50 hover:text-red-700 transition">Saídas</button>
                    </div>

                    <div id="transaction-list" class="space-y-6 pb-20">
                        <!-- Grouped by Date via JS -->
                    </div>
                </div>

                <!-- VIEW: Goals (INCREMENTADO) -->
                <div id="goals" class="hidden max-w-4xl mx-auto fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Metas Financeiras</h2>
                            <p class="text-slate-500 text-sm">Realize seus sonhos economizando.</p>
                        </div>
                        <button onclick="openModal('goal-modal')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-900 transition flex items-center gap-2 shadow-lg"><i class="fas fa-plus"></i> Nova Meta</button>
                    </div>

                    <div id="goal-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- JS injected -->
                    </div>
                </div>

                <!-- VIEW: Education (AJUDA & APRENDER - Mantido Melhorado) -->
                <div id="education" class="hidden max-w-4xl mx-auto fade-in">
                     <div id="edu-hub">
                        <div class="bg-gradient-to-r from-emerald-600 to-teal-500 rounded-2xl p-8 mb-8 text-center text-white relative overflow-hidden shadow-lg">
                            <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                            <div class="relative z-10">
                                <h2 class="text-2xl md:text-3xl font-bold mb-2">Central de Ajuda</h2>
                                <p class="text-emerald-100 mb-6 text-sm">Tutoriais e educação financeira.</p>
                                <div class="max-w-xl mx-auto relative">
                                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="edu-search" placeholder="Buscar ajuda..." class="w-full pl-12 pr-4 py-3.5 rounded-xl text-slate-800 focus:outline-none focus:ring-4 focus:ring-emerald-300/30 transition shadow-sm font-medium" onkeyup="filterEducation()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Categorias -->
                         <div class="flex gap-3 overflow-x-auto pb-4 mb-4 scrollbar-hide">
                            <button onclick="filterEducation('all')" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-full text-sm font-bold whitespace-nowrap hover:bg-emerald-200 transition">Tudo</button>
                            <button onclick="filterEducation('Orçamento')" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-full text-sm font-medium whitespace-nowrap hover:bg-slate-50 transition">Orçamento</button>
                            <button onclick="filterEducation('Tutorial')" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-full text-sm font-medium whitespace-nowrap hover:bg-slate-50 transition">Tutoriais</button>
                        </div>

                        <div id="education-content" class="grid sm:grid-cols-2 gap-4"></div>
                    </div>

                    <!-- Reader -->
                    <div id="edu-reader" class="hidden">
                        <button onclick="closeEduReader()" class="mb-4 text-sm text-slate-500 hover:text-emerald-600 font-medium flex items-center gap-2"><i class="fas fa-arrow-left"></i> Voltar</button>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8">
                            <span id="edu-reader-cat" class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold uppercase mb-4 inline-block"></span>
                            <h1 id="edu-reader-title" class="text-3xl font-bold text-slate-900 mb-6"></h1>
                            <div id="edu-reader-body" class="prose prose-emerald max-w-none text-slate-600"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Mobile Nav -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-2 flex justify-between items-center z-30 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button data-tab="dashboard" class="nav-item active flex flex-col items-center gap-1 text-xs font-medium text-slate-400 p-2"><i class="fas fa-home text-lg"></i> Início</button>
            <button data-tab="transactions" class="nav-item flex flex-col items-center gap-1 text-xs font-medium text-slate-400 p-2"><i class="fas fa-list text-lg"></i> Extrato</button>
            <div class="relative -top-6">
                <button onclick="openTransactionModal()" class="fab w-14 h-14 bg-emerald-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition transform hover:scale-105"><i class="fas fa-plus"></i></button>
            </div>
            <button data-tab="goals" class="nav-item flex flex-col items-center gap-1 text-xs font-medium text-slate-400 p-2"><i class="fas fa-bullseye text-lg"></i> Metas</button>
            <button data-tab="education" class="nav-item flex flex-col items-center gap-1 text-xs font-medium text-slate-400 p-2"><i class="fas fa-question-circle text-lg"></i> Ajuda</button>
        </nav>
        
        <!-- Desktop FAB -->
        <button onclick="openTransactionModal()" class="hidden md:flex fixed bottom-8 right-8 w-14 h-14 bg-emerald-600 rounded-full items-center justify-center text-white text-xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition z-40 transform hover:scale-105" title="Nova Transação"><i class="fas fa-plus"></i></button>
    </div>

    <!-- MODAL TRANSAÇÃO -->
    <div id="transaction-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 hidden opacity-0 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-t-2xl md:rounded-2xl w-full max-w-md p-6 animate-slide-up md:animate-none shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="transaction-modal-title" class="text-xl font-bold text-slate-800">Nova Movimentação</h2>
                <button onclick="hideModal('transaction-modal')" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="transaction-form" class="space-y-4">
                <input type="hidden" id="transaction-id">
                <div class="grid grid-cols-2 bg-slate-100 p-1 rounded-xl">
                    <label class="cursor-pointer"><input type="radio" name="type" value="income" class="peer sr-only" checked><div class="text-center py-2 rounded-lg text-sm font-medium text-slate-500 peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition">Receita</div></label>
                    <label class="cursor-pointer"><input type="radio" name="type" value="expense" class="peer sr-only"><div class="text-center py-2 rounded-lg text-sm font-medium text-slate-500 peer-checked:bg-white peer-checked:text-red-500 peer-checked:shadow-sm transition">Despesa</div></label>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Valor</label>
                    <div class="relative"><span class="absolute left-3 top-3 text-slate-400 font-medium">R$</span><input type="number" id="amount" step="0.01" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-emerald-500 font-bold text-lg text-slate-800" placeholder="0,00" required></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Descrição</label><input type="text" id="description" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-emerald-500" placeholder="Ex: Lanche, Xerox" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Data</label><input type="date" id="date" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" required></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categoria</label><select id="category" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm bg-white"><option>Alimentação</option><option>Transporte</option><option>Educação</option><option>Lazer</option><option>Outros</option></select></div>
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200 mt-4">Salvar Movimentação</button>
            </form>
        </div>
    </div>

    <!-- MODAL META -->
    <div id="goal-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden opacity-0 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Definir Meta</h2>
            <form id="goal-form" class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome da Meta</label><input type="text" id="goal-name" class="w-full px-4 py-2 border border-slate-200 rounded-lg outline-none focus:border-emerald-500" placeholder="Ex: Notebook Novo" required></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Valor Alvo</label><input type="number" id="goal-target" step="0.01" class="w-full px-4 py-2 border border-slate-200 rounded-lg outline-none focus:border-emerald-500" placeholder="R$ 0,00" required></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Já economizado (Inicial)</label><input type="number" id="goal-current" step="0.01" value="0" class="w-full px-4 py-2 border border-slate-200 rounded-lg outline-none focus:border-emerald-500" placeholder="R$ 0,00"></div>
                <div class="flex gap-3 mt-6"><button type="button" onclick="hideModal('goal-modal')" class="flex-1 py-2 text-slate-500 hover:bg-slate-50 rounded-lg transition">Cancelar</button><button type="submit" class="flex-1 bg-emerald-600 text-white font-bold py-2 rounded-lg hover:bg-emerald-700 transition">Salvar Meta</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL DEPOSITO META -->
    <div id="deposit-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden opacity-0 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fas fa-piggy-bank text-xl"></i></div>
            <h2 class="text-xl font-bold text-slate-800 text-center mb-1">Guardar Dinheiro</h2>
            <p id="deposit-goal-name" class="text-center text-slate-500 text-sm mb-6">Para: Nome da Meta</p>
            <form id="deposit-form" class="space-y-4">
                <input type="hidden" id="deposit-goal-id">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Valor a depositar</label>
                    <div class="relative"><span class="absolute left-3 top-3 text-slate-400 font-medium">R$</span><input type="number" id="deposit-amount" step="0.01" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-emerald-500 font-bold text-lg text-slate-800" placeholder="0,00" required></div>
                </div>
                <div class="flex gap-3 mt-6"><button type="button" onclick="hideModal('deposit-modal')" class="flex-1 py-2 text-slate-500 hover:bg-slate-50 rounded-lg transition">Cancelar</button><button type="submit" class="flex-1 bg-emerald-600 text-white font-bold py-2 rounded-lg hover:bg-emerald-700 transition">Confirmar</button></div>
            </form>
        </div>
    </div>
    
    <!-- MODAL CONFIRMAÇÃO -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden opacity-0 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-trash-alt"></i></div>
            <h3 class="font-bold text-lg text-slate-800">Tem certeza?</h3>
            <p id="confirmation-message" class="text-slate-500 text-sm mb-6">Essa ação não pode ser desfeita.</p>
            <div class="flex justify-center gap-3"><button id="confirm-cancel" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg font-medium hover:bg-slate-200 transition">Cancelar</button><button id="confirm-yes" class="px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition shadow-lg shadow-red-200">Sim, Excluir</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCyVlCT4BL1jhNDtstcCT9glYnSyVWLboU",
            authDomain: "castanheira-70daf.firebaseapp.com",
            projectId: "castanheira-70daf",
            storageBucket: "castanheira-70daf.appspot.com",
            messagingSenderId: "1065873289338",
            appId: "1:1065873289338:web:08ca3895f27bf825128bc3",
            measurementId: "G-CC3X31ES9P"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'educafin-redesign-v2';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let userId = null;
        let unsubscribeTrans = null;
        let unsubscribeGoals = null;
        let expenseChart = null;
        let allTransactions = [];
        let allGoals = [];
        let currentFilter = 'all';

        // --- PUBLIC CONTENT (Mantido) ---
        const publicBlogPosts = [
            { id: 1, title: "A Regra 50-30-20", category: "Orçamento", icon: "fa-chart-pie", desc: "Divida sua renda: 50% necessidades, 30% desejos, 20% futuro.", content: "<p>Conteúdo detalhado aqui...</p>" },
            { id: 2, title: "Investindo com R$ 30", category: "Investimentos", icon: "fa-seedling", desc: "Tesouro Direto e CDBs acessíveis para começar hoje.", content: "<p>Conteúdo detalhado aqui...</p>" },
            { id: 3, title: "Cartão: Aliado ou Vilão?", category: "Tutorial", icon: "fa-credit-card", desc: "Como acumular milhas sem pagar juros abusivos.", content: "<p>Conteúdo detalhado aqui...</p>" }
        ];
        const publicEvents = [ { id: 1, title: "Workshop: Finanças", date: "2025-10-15", time: "14:00", location: "Auditório Central", type: "Workshop" } ];

        function initPublicContent() {
            const list = document.getElementById('public-posts-list');
            list.innerHTML = '';
            publicBlogPosts.forEach(post => {
                const article = document.createElement('article');
                article.className = 'group cursor-pointer border-b border-slate-100 last:border-0 pb-6 last:pb-0';
                article.innerHTML = `<span class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-1 block">${post.category}</span><h3 class="text-xl font-bold group-hover:text-emerald-600 transition text-slate-800">${post.title}</h3><p class="text-slate-500 mt-2 text-sm">${post.desc}</p><button class="inline-flex items-center gap-1 mt-3 text-emerald-600 font-bold hover:underline text-sm" onclick="openBlogPost(${post.id})">Ler <i class="fas fa-arrow-right text-xs"></i></button>`;
                list.appendChild(article);
            });
            renderEducationCards();
        }

        // --- AUTH & INITIALIZATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                // Dynamic Greeting
                const hour = new Date().getHours();
                const greeting = hour < 12 ? 'Bom dia' : hour < 18 ? 'Boa tarde' : 'Boa noite';
                const userName = user.displayName ? user.displayName.split(' ')[0] : 'Usuário';
                document.getElementById('header-greeting').textContent = `${greeting}, ${userName}`;
                document.getElementById('dash-greeting-title').textContent = `${greeting}, ${userName}!`;
                document.getElementById('user-photo').src = user.photoURL || `https://ui-avatars.com/api/?name=${userName}&background=059669&color=fff`;
                
                initApp();
                switchTab('dashboard');
            } else {
                userId = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                if(unsubscribeTrans) unsubscribeTrans();
                if(unsubscribeGoals) unsubscribeGoals();
                showPublicHome();
            }
        });

        // --- APP LOGIC ---
        function initApp() {
            const transRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            const qTrans = query(transRef, orderBy('timestamp', 'desc'));
            unsubscribeTrans = onSnapshot(qTrans, (snap) => {
                allTransactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderUI();
            });

            const goalsRef = collection(db, `artifacts/${appId}/users/${userId}/goals`);
            unsubscribeGoals = onSnapshot(goalsRef, (snap) => {
                allGoals = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderUI();
            });
        }

        function renderUI() {
            let income = 0, expense = 0, cats = {};
            
            // Populate Month Filter
            const months = [...new Set(allTransactions.map(t => t.timestamp?.toDate ? t.timestamp.toDate().toLocaleString('default', { month: 'long', year: 'numeric' }) : null))].filter(Boolean);
            const monthSelect = document.getElementById('trans-month-filter');
            // Keep selected value if exists, else 'all'
            const currentMonthVal = monthSelect.value;
            monthSelect.innerHTML = '<option value="all">Todos os meses</option>';
            months.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m.charAt(0).toUpperCase() + m.slice(1);
                monthSelect.appendChild(opt);
            });
            monthSelect.value = currentMonthVal;

            allTransactions.forEach(t => {
                if(t.type === 'income') income += t.amount;
                else { expense += t.amount; cats[t.category] = (cats[t.category] || 0) + t.amount; }
            });

            // Update Stats
            document.getElementById('total-income').textContent = formatBRL(income);
            document.getElementById('total-expense').textContent = formatBRL(expense);
            document.getElementById('current-balance').textContent = formatBRL(income - expense);
            
            // Budget Bar (Simulado: 80% do income é o limite ideal)
            const budgetLimit = income * 0.8 || 1; 
            const budgetPercent = Math.min(100, (expense / budgetLimit) * 100);
            document.getElementById('budget-bar').style.width = `${budgetPercent}%`;
            document.getElementById('budget-percent').textContent = `${budgetPercent.toFixed(0)}%`;

            renderTransactionsList();
            renderDashboardRecent();
            renderGoals();
            renderChart(cats);
        }

        function renderDashboardRecent() {
            const list = document.getElementById('recent-activity-list');
            list.innerHTML = '';
            const recent = allTransactions.slice(0, 5); // Last 5
            
            if(recent.length === 0) {
                list.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">Nenhuma atividade recente.</p>';
                return;
            }

            recent.forEach(t => {
                const isInc = t.type === 'income';
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-3 rounded-xl hover:bg-slate-50 transition cursor-pointer border border-transparent hover:border-slate-100';
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${isInc ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-500'} text-xs">
                            <i class="fas ${isInc ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-700 truncate w-32">${t.description}</p>
                            <p class="text-xs text-slate-400">${t.timestamp?.toDate ? t.timestamp.toDate().toLocaleDateString('pt-BR') : ''}</p>
                        </div>
                    </div>
                    <span class="text-sm font-bold ${isInc ? 'text-emerald-600' : 'text-slate-800'}">${isInc ? '+' : '-'} ${formatBRL(t.amount)}</span>
                `;
                list.appendChild(el);
            });
        }

        function renderTransactionsList() {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            
            const searchTerm = document.getElementById('trans-search').value.toLowerCase();
            const monthFilter = document.getElementById('trans-month-filter').value;
            
            const filtered = allTransactions.filter(t => {
                const matchesType = currentFilter === 'all' || t.type === currentFilter;
                const matchesSearch = t.description.toLowerCase().includes(searchTerm) || t.category.toLowerCase().includes(searchTerm);
                const tDate = t.timestamp?.toDate ? t.timestamp.toDate() : null;
                const matchesMonth = monthFilter === 'all' || (tDate && tDate.toLocaleString('default', { month: 'long', year: 'numeric' }) === monthFilter);
                return matchesType && matchesSearch && matchesMonth;
            });

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-12 text-slate-400 flex flex-col items-center"><div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><i class="fas fa-receipt text-2xl text-slate-300"></i></div><p>Nenhuma movimentação encontrada.</p></div>`;
                return;
            }

            // Group by Date
            const grouped = {};
            filtered.forEach(t => {
                const dateStr = t.timestamp?.toDate ? t.timestamp.toDate().toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' }) : 'Data desconhecida';
                if(!grouped[dateStr]) grouped[dateStr] = [];
                grouped[dateStr].push(t);
            });

            Object.keys(grouped).forEach(dateGroup => {
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `<h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1 sticky top-0 bg-slate-50/90 backdrop-blur-sm py-2 z-10">${dateGroup}</h3>`;
                const stack = document.createElement('div');
                stack.className = 'space-y-2';
                
                grouped[dateGroup].forEach(t => {
                    const isInc = t.type === 'income';
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between group transition hover:shadow-md';
                    item.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${isInc ? 'bg-emerald-100 text-emerald-600' : 'bg-red-50 text-red-500'}">
                                <i class="fas ${getIconForCategory(t.category)}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm">${t.description}</p>
                                <p class="text-xs text-slate-400">${t.category}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${isInc ? 'text-emerald-600' : 'text-slate-800'}">${isInc ? '+' : '-'} ${formatBRL(t.amount)}</p>
                            <div class="flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition">
                                <button onclick="editTransaction('${t.id}')" class="text-xs text-blue-400 hover:text-blue-600 p-1"><i class="fas fa-pencil-alt"></i></button>
                                <button onclick="deleteTransaction('${t.id}')" class="text-xs text-red-400 hover:text-red-600 p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    stack.appendChild(item);
                });
                groupDiv.appendChild(stack);
                list.appendChild(groupDiv);
            });
        }

        function renderGoals() {
            const list = document.getElementById('goal-list');
            list.innerHTML = '';
            
            if(allGoals.length === 0) {
                list.innerHTML = `<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-slate-300"><i class="fas fa-piggy-bank text-4xl text-emerald-200 mb-3"></i><p class="text-slate-500">Nenhuma meta criada. Comece a economizar!</p></div>`;
                return;
            }

            allGoals.forEach(g => {
                const current = g.currentAmount || 0;
                const pct = Math.min(100, Math.max(0, (current / g.targetAmount) * 100));
                
                // Colors based on progress
                let colorClass = 'bg-red-500';
                if(pct > 25) colorClass = 'bg-yellow-400';
                if(pct > 75) colorClass = 'bg-emerald-500';
                if(pct >= 100) colorClass = 'bg-emerald-400';

                const item = document.createElement('div');
                item.className = 'bg-white p-6 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden group hover:shadow-md transition';
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400">
                            <i class="fas fa-trophy ${pct >= 100 ? 'text-yellow-400' : ''}"></i>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="openDepositModal('${g.id}', '${g.name}')" class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center hover:bg-emerald-100 transition" title="Adicionar Dinheiro"><i class="fas fa-plus"></i></button>
                             <button onclick="deleteGoal('${g.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 mb-1">${g.name}</h3>
                    <div class="flex justify-between text-xs text-slate-500 mb-3">
                        <span>${formatBRL(current)}</span>
                        <span>de ${formatBRL(g.targetAmount)}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden mb-2">
                        <div class="${colorClass} h-full rounded-full transition-all duration-1000 relative" style="width: ${pct}%">
                             <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                        </div>
                    </div>
                    <p class="text-right text-xs font-bold text-slate-400">${pct.toFixed(0)}% Concluído</p>
                `;
                list.appendChild(item);
            });
        }

        function renderChart(data) {
            const ctx = document.getElementById('expense-chart').getContext('2d');
            if(expenseChart) expenseChart.destroy();
            expenseChart = new Chart(ctx, { 
                type: 'doughnut', // Doughnut looks cleaner for dashboard
                data: { 
                    labels: Object.keys(data), 
                    datasets: [{ 
                        label: 'Gastos', 
                        data: Object.values(data), 
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '70%',
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } } 
                    } 
                } 
            });
        }

        // --- EDUCATION CENTER (Mantido) ---
        function renderEducationCards(filterText = '', filterCat = 'all') {
            const eduContent = document.getElementById('education-content');
            eduContent.innerHTML = '';
            const filtered = publicBlogPosts.filter(p => {
                const matchesText = p.title.toLowerCase().includes(filterText.toLowerCase()) || p.desc.toLowerCase().includes(filterText.toLowerCase());
                const matchesCat = filterCat === 'all' || p.category === filterCat;
                return matchesText && matchesCat;
            });
            filtered.forEach(post => {
                const el = document.createElement('div');
                el.className = 'bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition cursor-pointer flex flex-col h-full';
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center border border-emerald-100"><i class="fas ${post.icon}"></i></div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wide bg-slate-50 px-2 py-1 rounded-lg">${post.category}</span>
                    </div>
                    <h3 class="font-bold text-slate-800 mb-2 leading-tight text-lg">${post.title}</h3>
                    <p class="text-sm text-slate-500 line-clamp-3 mb-4 flex-1">${post.desc}</p>
                    <button class="text-emerald-600 text-sm font-bold hover:underline flex items-center gap-1 self-start" onclick="openEduReaderInside(${post.id})">Ler Agora <i class="fas fa-arrow-right text-xs"></i></button>
                `;
                eduContent.appendChild(el);
            });
        }
        window.filterEducation = (cat) => { const text = document.getElementById('edu-search')?.value || ''; renderEducationCards(text, cat || 'all'); };
        window.openEduReaderInside = (id) => { const post = publicBlogPosts.find(p => p.id === id); if(!post) return; document.getElementById('edu-reader-cat').textContent = post.category; document.getElementById('edu-reader-title').textContent = post.title; document.getElementById('edu-reader-body').innerHTML = post.content; document.getElementById('edu-hub').classList.add('hidden'); document.getElementById('edu-reader').classList.remove('hidden'); };
        window.closeEduReader = () => { document.getElementById('edu-reader').classList.add('hidden'); document.getElementById('edu-hub').classList.remove('hidden'); };

        // --- HELPERS ---
        window.getIconForCategory = (cat) => {
            if(!cat) return 'fa-tag';
            const map = { 'Alimentação': 'fa-utensils', 'Transporte': 'fa-car', 'Educação': 'fa-book', 'Lazer': 'fa-gamepad', 'Outros': 'fa-box' };
            return map[cat] || 'fa-tag';
        }
        
        window.openTransactionModal = (type) => { 
            document.getElementById('transaction-form').reset(); 
            document.getElementById('transaction-id').value = ''; 
            document.getElementById('date').valueAsDate = new Date(); 
            if(type) document.querySelector(`input[name="type"][value="${type}"]`).checked = true;
            document.getElementById('transaction-modal').classList.remove('hidden'); 
            setTimeout(() => document.getElementById('transaction-modal').classList.remove('opacity-0'), 10); 
        };
        
        window.openDepositModal = (id, name) => {
            document.getElementById('deposit-form').reset();
            document.getElementById('deposit-goal-id').value = id;
            document.getElementById('deposit-goal-name').textContent = `Para: ${name}`;
            document.getElementById('deposit-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('deposit-modal').classList.remove('opacity-0'), 10); 
        };

        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); setTimeout(() => document.getElementById(id).classList.remove('opacity-0'), 10); }
        window.hideModal = (id) => { document.getElementById(id).classList.add('opacity-0'); setTimeout(() => document.getElementById(id).classList.add('hidden'), 300); };
        window.formatBRL = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        window.exportReport = () => { const csvContent = "data:text/csv;charset=utf-8," + ["Data,Descrição,Categoria,Valor,Tipo"].join(",") + "\n" + allTransactions.map(t => `${t.timestamp?.toDate ? t.timestamp.toDate().toLocaleDateString() : ''},${t.description},${t.category},${t.amount},${t.type}`).join("\n"); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "relatorio.csv"); document.body.appendChild(link); link.click(); }
        window.switchTab = (tabName) => {
            document.querySelectorAll('.nav-item').forEach(btn => { btn.classList.toggle('active', btn.dataset.tab === tabName); if(btn.dataset.tab === tabName) btn.classList.add('text-emerald-600'); else btn.classList.remove('text-emerald-600'); });
            document.querySelectorAll('.nav-item-desktop').forEach(btn => { const isActive = btn.dataset.tab === tabName; btn.className = isActive ? 'nav-item-desktop active w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg bg-emerald-50 text-emerald-700' : 'nav-item-desktop w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900'; });
            ['dashboard', 'transactions', 'goals', 'education'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
        };

        // --- GLOBAL ACTIONS ---
        document.querySelectorAll('[data-tab]').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
        document.querySelectorAll('.filter-btn').forEach(btn => { btn.addEventListener('click', () => { currentFilter = btn.dataset.filter; document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('active', 'bg-slate-800', 'text-white'); b.classList.add('bg-white', 'text-slate-600'); }); btn.classList.remove('bg-white', 'text-slate-600'); btn.classList.add('active', 'bg-slate-800', 'text-white'); renderTransactionsList(); }); });

        // --- FIRESTORE ACTIONS ---
        document.getElementById('transaction-form').addEventListener('submit', async e => { e.preventDefault(); const id = document.getElementById('transaction-id').value; const data = { description: document.getElementById('description').value, amount: parseFloat(document.getElementById('amount').value), type: document.querySelector('input[name="type"]:checked').value, category: document.getElementById('category').value, timestamp: new Date(document.getElementById('date').value) }; if(id) await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id), data); else await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), data); hideModal('transaction-modal'); });
        document.getElementById('goal-form').addEventListener('submit', async e => { e.preventDefault(); await addDoc(collection(db, `artifacts/${appId}/users/${userId}/goals`), { name: document.getElementById('goal-name').value, targetAmount: parseFloat(document.getElementById('goal-target').value), currentAmount: parseFloat(document.getElementById('goal-current').value) || 0 }); hideModal('goal-modal'); });
        document.getElementById('deposit-form').addEventListener('submit', async e => { 
            e.preventDefault(); 
            const id = document.getElementById('deposit-goal-id').value; 
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const goal = allGoals.find(g => g.id === id);
            if(goal) {
                const newTotal = (goal.currentAmount || 0) + amount;
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/goals`, id), { currentAmount: newTotal });
                if(newTotal >= goal.targetAmount) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
            hideModal('deposit-modal'); 
        });

        window.editTransaction = (id) => { const t = allTransactions.find(x => x.id === id); if(!t) return; document.getElementById('transaction-id').value = id; document.getElementById('description').value = t.description; document.getElementById('amount').value = t.amount; document.getElementById('category').value = t.category; document.getElementById('date').valueAsDate = t.timestamp.toDate(); document.querySelector(`input[name="type"][value="${t.type}"]`).checked = true; document.getElementById('transaction-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('transaction-modal').classList.remove('opacity-0'), 10); };
        window.deleteTransaction = (id) => { document.getElementById('confirmation-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('confirmation-modal').classList.remove('opacity-0'), 10); const yesBtn = document.getElementById('confirm-yes'); const newYes = yesBtn.cloneNode(true); yesBtn.parentNode.replaceChild(newYes, yesBtn); newYes.addEventListener('click', async () => { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id)); hideModal('confirmation-modal'); }); document.getElementById('confirm-cancel').onclick = () => hideModal('confirmation-modal'); };
        window.deleteGoal = async (id) => { if(confirm('Excluir meta?')) await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/goals`, id)); };

        // Auth handling for providers is already set in HTML onclick attributes
        document.getElementById('google-login-button').addEventListener('click', () => signInWithPopup(auth, googleProvider).catch(handleAuthError));
        document.getElementById('anonymous-login-button').addEventListener('click', () => signInAnonymously(auth).catch(handleAuthError));
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        const handleAuthError = (err) => { console.error(err); document.getElementById('auth-status').textContent = `Erro: ${err.message}`; };

        initPublicContent();
    </script>
</body>
</html>